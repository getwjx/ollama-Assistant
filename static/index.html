<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title">ollamaçš„å°åŠ©æ‰‹</title>
    <style>

        /* å…¨å±€æ ·å¼å˜é‡ */
        :root {
            --background-color: #F3F5FC;
            --primary-color: #000;
            --border-color: #000;
            --text-color: #060607;
            --scrollbar-color: #000;
            --scrollbar-hover: #000;
            --input-bg-color: #FFFFFF;
            --input-border-color: #FFFFFF;
            --user-color: #2D65F7;
            --user-text-color: #FFFFFF;
            --assistant-color: #FFFFFF;
            --assistant-text-color: #000;
            --button-text-color: #FFFFFF;
        }

        /* é€šç”¨æ ·å¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        button, input[type="text"], .upload-container label {
            border-radius: 10px;
            font-size: 16px;
            padding: 10px;
            margin: 3px 0;
        }

        button:hover, .upload-container label:hover {
            background-color: #2D65F7;
        }

        button {
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: background-color 0.3s;
        }

        input[type="text"]:focus, button:focus {
            outline: none;
            /*border-color: #8e867f;*/
            /*box-shadow: 0 0 5px rgba(142, 134, 127, 0.5);*/
        }

        select {
            padding: 5px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--background-color);
            color: var(--text-color);
            cursor: pointer;
            width: 150px;
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .options-container {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* èŠå¤©æ¡†æ ·å¼ */
        #chat-box {
            width: 90%;
            max-width: 1000px;
            margin: 3px auto;
            height: 88vh;
            /*border: 1px solid var(--border-color);*/
            border-radius: 12px;
            background-color: var(--background-color);
            /*box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);*/
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            margin-top: 70px;
            width: auto;
            height: auto;
            /*border-top: 1px solid var(--border-color);*/
            /*border-bottom: 1px solid var(--border-color);*/
            padding: 10px 0;
            margin-bottom: 3px;
        }

        .message {
            margin: 3px 0;
            padding: 10px;
            border-radius: 8px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .message.user {
            display: flex; /* ä½¿ç”¨ Flexbox å¸ƒå±€ */
            justify-content: flex-end; /* å­å…ƒç´ é å³å¯¹é½ */
        }

        .message.user p {
            background-color: var(--user-color); /* èƒŒæ™¯é¢œè‰² */
            display: inline-block; /* å®½åº¦æ ¹æ®å†…å®¹åŠ¨æ€è°ƒæ•´ */
            padding: 10px; /* å†…è¾¹è·ï¼Œå¢åŠ è§†è§‰ç¾æ„Ÿ */
            border-radius: 8px; /* åœ†è§’æ•ˆæœ */
            max-width: 80%; /* é™åˆ¶æœ€å¤§å®½åº¦ä¸ºçˆ¶å®¹å™¨çš„ 80% */
            word-wrap: break-word; /* é•¿å†…å®¹è‡ªåŠ¨æ¢è¡Œ */
            text-align: left; /* æ–‡æœ¬å†…å®¹å·¦å¯¹é½ */
            color: var(--user-text-color);
            margin: 0; /* å»æ‰æ®µè½çš„é»˜è®¤å¤–è¾¹è· */
        }


        .message.assistant {
            display: flex; /* ä½¿ç”¨ Flexbox å¸ƒå±€ */
            flex-direction: column;
            justify-content: flex-start; /* å­å…ƒç´ é å³å¯¹é½ */
        }

        .message.assistant pre {
            background-color: var(--assistant-color); /* èƒŒæ™¯é¢œè‰² */
            display: inline-block; /* å®½åº¦æ ¹æ®å†…å®¹åŠ¨æ€è°ƒæ•´ */
            padding: 10px; /* å†…è¾¹è·ï¼Œå¢åŠ è§†è§‰ç¾æ„Ÿ */
            border-radius: 8px; /* åœ†è§’æ•ˆæœ */
            /*max-width: 80%; !* é™åˆ¶æœ€å¤§å®½åº¦ä¸ºçˆ¶å®¹å™¨çš„ 80% *!*/
            word-wrap: break-word; /* é•¿å†…å®¹è‡ªåŠ¨æ¢è¡Œ */
            text-align: left; /* æ–‡æœ¬å†…å®¹å·¦å¯¹é½ */
            color: var(--assistant-text-color);
            margin: 0; /* å»æ‰æ®µè½çš„é»˜è®¤å¤–è¾¹è· */
        }

        .message.assistant table {
            background-color: #c7e4c7; /* èƒŒæ™¯é¢œè‰² */
            display: inline-block; /* å®½åº¦æ ¹æ®å†…å®¹åŠ¨æ€è°ƒæ•´ */
            padding: 10px; /* å†…è¾¹è·ï¼Œå¢åŠ è§†è§‰ç¾æ„Ÿ */
            border-radius: 8px; /* åœ†è§’æ•ˆæœ */
            /*max-width: 80%; !* é™åˆ¶æœ€å¤§å®½åº¦ä¸ºçˆ¶å®¹å™¨çš„ 80% *!*/
            word-wrap: break-word; /* é•¿å†…å®¹è‡ªåŠ¨æ¢è¡Œ */
            text-align: left; /* æ–‡æœ¬å†…å®¹å·¦å¯¹é½ */
            color: var(--assistant-text-color);
            margin: 0; /* å»æ‰æ®µè½çš„é»˜è®¤å¤–è¾¹è· */
        }

        img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 3px;
            /*box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);*/
        }

        .upload-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            color: var(--button-text-color);
        }

        .upload-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-container label {
            display: block;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .button-container {
            display: flex; /* ä½¿ç”¨ Flexbox å¸ƒå±€ */
            justify-content: flex-end; /* å·¦å¯¹é½æŒ‰é’® */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            gap: 10px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
        }

        .upload-container label {
            display: inline-block; /* ä¿è¯ label çš„æ ·å¼æ˜¯å—çŠ¶ä¸”æ”¯æŒæ°´å¹³æ’åˆ— */
            text-align: center; /* æ–‡æœ¬å±…ä¸­ */
            background-color: var(--primary-color); /* å¯é€‰ï¼šä¸Šä¼ å›¾ç‰‡æŒ‰é’®èƒŒæ™¯é¢œè‰² */
            padding: 10px; /* å¯é€‰ï¼šå¢åŠ æŒ‰é’®çš„ç‚¹å‡»åŒºåŸŸ */
            border-radius: 6px; /* å¯é€‰ï¼šåœ†è§’æ•ˆæœ */
            cursor: pointer; /* é¼ æ ‡ç§»å…¥æ—¶æ˜¾ç¤ºæ‰‹å‹æŒ‡é’ˆ */
            text-color: var(--button-text-color);
        }

        .prompt {
            background: var(--input-bg-color);
            color: var(--assistant-text-color);
            border: none;
            outline: none;
        }

        #sendButton {
            padding: 10px; /* å¯é€‰ï¼šå‘é€æŒ‰é’®å†…è¾¹è· */
            border: none; /* å¯é€‰ï¼šå»æ‰æŒ‰é’®è¾¹æ¡† */
            border-radius: 6px; /* å¯é€‰ï¼šåœ†è§’æ•ˆæœ */
            background-color: var(--primary-color); /* å¯é€‰ï¼šè®¾ç½®æŒ‰é’®èƒŒæ™¯è‰² */
            color: white; /* å¯é€‰ï¼šæŒ‰é’®æ–‡æœ¬é¢œè‰² */
            cursor: pointer; /* é¼ æ ‡ç§»å…¥æ—¶æ˜¾ç¤ºæ‰‹å‹æŒ‡é’ˆ */
        }

        #sendButton:hover {
            background-color: #0056b3; /* é¼ æ ‡æ‚¬åœæ—¶æ›´æ·±çš„è“è‰² */
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-color);
            border-radius: 4px;
            width: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--scrollbar-hover);
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .flush {
            background: var(--primary-color);
            color: var(--button-text-color);
            position: absolute;
            padding: 10px; /* å¯é€‰ï¼šå‘é€æŒ‰é’®å†…è¾¹è· */
            -webkit-appearance: none;
            -moz-appearance: none;
            border: none;
            border-radius: 6px; /* å¯é€‰ï¼šåœ†è§’æ•ˆæœ */
            background-color: var(--primary-color); /* å¯é€‰ï¼šè®¾ç½®æŒ‰é’®èƒŒæ™¯è‰² */
            cursor: pointer; /* é¼ æ ‡ç§»å…¥æ—¶æ˜¾ç¤ºæ‰‹å‹æŒ‡é’ˆ */
        }

        /* å“åº”å¼è®¾è®¡ */
        @media screen and (max-width: 768px) {
            #chat-box {
                width: 92%;
                height: 90vh;
                padding: 15px;
            }

            h2 {
                font-size: 18px;
            }

            input[type="text"], button, .upload-container label {
                font-size: 14px;
                padding: 10px;
            }
        }

    </style>
    <script type="module">
        import {marked} from 'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js';

        window.marked = marked;
    </script>
</head>
<body>
<div id="chat-box">
    <button id="flush" class="flush" onclick="location.reload();">é‡ç½®</button>
    <div class="options-container">
        <select id="theme-switcher" onchange="changeTheme(this.value)">
            <option value="morandi">ç™½å¤©æ¨¡å¼</option>
            <option value="dark">é»‘å¤œæ¨¡å¼</option>
        </select>
        <select id="language-switcher" onchange="toggleLanguage(this.value)">
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="fr">FranÃ§ais</option>
        </select>
    </div>
    <div style="text-align: left; margin-bottom: 10px; position: absolute;margin-top: 50px;">
        <span id="info-text" style="font-size: 14px; color: #F44336; font-weight: bold;">
            âš ï¸ å›ç­”ä¸å®Œå…¨æ­£ç¡®ï¼Œä»…ä¾›å‚è€ƒï¼
        </span>
    </div>
    <div id="messages"></div>

    <input type="text"
           id="prompt" class="prompt" placeholder="åœ¨è¿™è¾“å…¥ä½ è¦å‘é€çš„ä¿¡æ¯..." onkeydown="handleKeyDown(event)"/>
    <div class="button-container">
        <select id="model-select" onchange="updateModelSet(this.value)" style="width: 150px">
        </select>
        <div class="upload-container">
            <label for="fileInput">ğŸ“ ä¸Šä¼ å›¾ç‰‡</label>
            <input type="file" id="fileInput" accept="image/*" onchange="handleImageInput(event)"/>
        </div>
        <!-- å°†å½•éŸ³æŒ‰é’®ä¿ç•™æ³¨é‡ŠçŠ¶æ€ -->
        <!-- <button id="recordButton">ğŸ™ï¸ é•¿æŒ‰å½•éŸ³(æš‚ä¸èƒ½ç”¨,å»ºè®®ä½¿ç”¨è¾“å…¥æ³•çš„è¯­éŸ³è½¬æ–‡å­—)</button> -->
        <button id="sendButton" onclick="sendMessage()">å‘é€</button>
    </div>
</div>
<script>
    let conversationHistory = [
        {
            role: "system",
            content: "You're a multilingual assistant that answers questions in the language of the question."
        }
    ];
    let uploadedImagePath = null;
    let currentLanguage = "zh";

    let model_set = '';

    const translations = {
        zh: {
            title: "ollamaçš„å°åŠ©æ‰‹",
            promptPlaceholder: "åœ¨è¿™è¾“å…¥ä½ è¦å‘é€çš„ä¿¡æ¯...",
            uploadLabel: "ğŸ“ ä¸Šä¼ å›¾ç‰‡",
            sendButton: "å‘é€",
            tip: "âš ï¸ å›ç­”ä¸å®Œå…¨æ­£ç¡®ï¼Œä»…ä¾›å‚è€ƒï¼",
            reset: "é‡ç½®",
        },
        en: {
            title: "ollama's Assistant",
            promptPlaceholder: "Type your message here...",
            uploadLabel: "ğŸ“ Upload Image",
            sendButton: "Send",
            tip: "âš ï¸ Answer not complete, for reference only.",
            reset: "Reset"
        },
        de: {
            title: "ollama Assistent",
            promptPlaceholder: "Geben Sie Ihre Nachricht hier ein...",
            uploadLabel: "ğŸ“ Bild hochladen",
            sendButton: "Senden",
            tip: "âš ï¸ Antwort nicht vollstÃ¤ndig, nur fÃ¼r Referenz.",
            reset: "Neu starten"
        },
        ja: {
            title: "ollamaã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
            promptPlaceholder: "ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...",
            uploadLabel: "ğŸ“ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
            sendButton: "é€ä¿¡",
            tip: "âš ï¸ å›ç­”ãŒä¸å®Œå…¨ã§ã™ã€‚å‚è€ƒç›®çš„ã®ã¿ã€‚",
            reset: "ãƒªã‚»ãƒƒãƒˆ"
        },
        fr: {
            title: "Assistant de ollama",
            promptPlaceholder: "Tapez votre message ici...",
            uploadLabel: "ğŸ“ TÃ©lÃ©charger l'image",
            sendButton: "Envoyer",
            tip: "âš ï¸ RÃ©ponse incomplÃ¨te, uniquement pour rÃ©fÃ©rence.",
            reset: "RÃ©initialiser"
        }
    };
    const themes = {
        morandi: {
            "--background-color": "#F3F5FC", // è«å…°è¿ªæ·¡é›…ç™½ç±³è‰²
            "--primary-color": "#000",   // è«å…°è¿ªæ¸…æ–°æµ…è¤
            "--border-color": "#000",    // æŸ”å’Œæµ…ç°è¤è¾¹æ¡†
            "--text-color": "#060607",      // æ·±ç°è¤æ–‡å­—è‰²
            "--input-bg-color": "#FFFFFF",  // è¾“å…¥æ¡†èƒŒæ™¯ç™½è‰²
            "--input-border-color": "#FFFFFF", // è¾“å…¥æ¡†è¾¹æ¡†æµ…è¤è‰²
            "--scrollbar-color": "#7E7E7E", // æ»šåŠ¨æ¡è«å…°è¿ªç°
            "--scrollbar-hover": "#a79f96",  // æ»šåŠ¨æ¡æ‚¬åœç°
            "--user-color": "#2672ED",
            "--user-text-color": "#FFFFFF",
            "--assistant-color": "#FFFFFF",
            "--assistant-text-color": "#000",
            "--button-text-color": "#FFFFFF"

        },
        dark: {
            "--background-color": "#262630", // æ·±è«å…°è¿ªé»‘ç°
            "--primary-color": "#595965",   // æ·±è«å…°è¿ªè¤
            "--border-color": "#61564d",    // æ·±ç°è¤è¾¹æ¡†
            "--text-color": "#F5F9FFF2",      // æŸ”å’Œæµ…ç™½
            "--input-bg-color": "#595965",  // è¾“å…¥æ¡†èƒŒæ™¯æ·±ç°
            "--input-border-color": "#595965", // è¾“å…¥æ¡†è¾¹æ¡†æ·±ç°è¤
            "--scrollbar-color": "#45454E", // æ»šåŠ¨æ¡æ·±ç°
            "--scrollbar-hover": "#000",  // æ»šåŠ¨æ¡æ‚¬åœé¢œè‰²
            "--user-color": "#2672ED",
            "--user-text-color": "#FFFFFF",
            "--assistant-color": "#31313A",
            "--assistant-text-color": "#FFFFFF",
            "--button-text-color": "#FFFFFF"
        }
    };

    function changeTheme(themeName) {
        const root = document.documentElement;
        const theme = themes[themeName];
        for (const [key, value] of Object.entries(theme)) {
            root.style.setProperty(key, value);
        }
    }

    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let startTime;

    const recordButton = document.getElementById("recordButton");

    // recordButton.addEventListener("mousedown", startRecording);
    // recordButton.addEventListener("mouseup", stopRecording);

    async function startRecording() {
        if (isRecording) return;

        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.start();
            isRecording = true;
            startTime = Date.now();
            recordButton.innerText = "å½•éŸ³ä¸­...";
            recordButton.style.backgroundColor = "#ff5252";
        } catch (error) {
            alert("æ— æ³•å¯åŠ¨å½•éŸ³ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™ï¼");
        }
    }

    async function stopRecording() {
        if (!isRecording) return;

        const duration = Date.now() - startTime;
        if (duration < 1000) {
            alert("å½•éŸ³æ—¶é—´å¤ªçŸ­ï¼Œè¯·è‡³å°‘å½•åˆ¶ 1 ç§’ï¼");
            resetRecordingUI();
            return;
        }

        mediaRecorder.stop();
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, {type: "audio/wav"});
            audioChunks = [];
            resetRecordingUI();

            try {
                const formData = new FormData();
                formData.append("file", audioBlob, "audio.wav");

                const response = await fetch("/upload", {
                    method: "POST",
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error("ä¸Šä¼ å½•éŸ³æ–‡ä»¶å¤±è´¥ï¼");
                }

                const data = await response.json();
                transcribeAudio(data.filePath);
            } catch (error) {
                alert("ä¸Šä¼ å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
            }
        };
    }

    function resetRecordingUI() {
        isRecording = false;
        recordButton.innerText = "ğŸ™ï¸ é•¿æŒ‰å½•éŸ³";
        recordButton.style.backgroundColor = "";
    }

    async function transcribeAudio(audioPath) {
        try {
            const response = await fetch("/chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    model: "whisper",
                    messages: [{role: "user", content: "audio", images: [audioPath]}],
                }),
            });

            if (!response.ok) {
                throw new Error("è¯­éŸ³è½¬æ–‡å­—å¤±è´¥ï¼");
            }

            const result = await response.json();
            displayMessage("assistant", result.transcription);
        } catch (error) {
            alert("è¯­éŸ³è½¬æ–‡å­—å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
        }
    }

    function displayMessage(role, content) {
        const messagesDiv = document.getElementById("messages");
        const message = document.createElement("div");
        message.className = `message ${role}`;

        // æ£€æŸ¥å¹¶æ¸²æŸ“ Markdown
        if (typeof content === "string" && typeof window.marked === "function") {
            message.innerHTML = window.marked(content, {
                sanitize: true,
                gfm: true,
            });
        } else {
            message.innerText = content; // å›é€€åˆ°çº¯æ–‡æœ¬
        }

        messagesDiv.appendChild(message);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }


    function toggleLanguage(language) {
        currentLanguage = language;
        const lang = translations[language];
        //document.getElementById("title").innerText = lang.title;
        document.getElementById("prompt").placeholder = lang.promptPlaceholder;
        document.querySelector(".upload-container label").innerText = lang.uploadLabel;
        document.getElementById("sendButton").innerText = lang.sendButton;
        document.getElementById("flush").innerText = lang.reset;
        document.getElementById("info-text").innerText = lang.tip;
        document.getElementById("title").innerText = lang.title;
    }

    async function handleImageInput(event) {
        const file = event.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch("/upload", {
                    method: "POST",
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error("Failed to upload image.");
                }

                const data = await response.json();
                uploadedImagePath = data.filePath;

                const messagesDiv = document.getElementById("messages");
                const imagePreview = document.createElement("div");
                imagePreview.className = "message user";
                const img = document.createElement("img");
                img.src = uploadedImagePath;
                imagePreview.appendChild(img);
                messagesDiv.appendChild(imagePreview);

                event.target.value = "";
                scrollToBottom();
            } catch (error) {
                console.error("Error uploading image:", error);
                alert("Failed to upload image.");
            }
        }
    }

    async function fetchModelData() {
        const selectElement = document.getElementById("model-select");

        try {
            // å‘èµ·GETè¯·æ±‚è·å–æ¨¡å‹æ•°æ®
            const response = await fetch("/get-list", {
                method: "GET",  // ä½¿ç”¨GETè¯·æ±‚
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const modelData = await response.json();

            // æ¸…ç©ºä¹‹å‰çš„é€‰é¡¹
            selectElement.innerHTML = '';
            model_set = modelData[0].name
            modelData.forEach(model => {
                let optionText = `${model.name}`; // è‡ªå®šä¹‰æ–‡å­—
                if (model.name === 'llama3.2-vision:latest') {
                    optionText = `æ”¯æŒå›¾ç‰‡${model.name}`;
                }

                const option = document.createElement("option");
                option.value = model.name; // è®¾ç½®æ¨¡å‹çš„ name ä¸ºé€‰é¡¹çš„å€¼
                option.textContent = optionText; // æ˜¾ç¤ºåç§°å’Œè‡ªå®šä¹‰æ–‡å­—

                // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¾ç½®é»˜è®¤é€‰ä¸­é¡¹
                if (model.name === 'llama3.2-vision:latest') {
                    option.selected = true;
                    model_set = 'llama3.2-vision:latest';
                }
                selectElement.appendChild(option);
            });
        } catch (error) {
            console.error("Error:", error.message);
            alert(`Error: ${error.message}`);
        }
    }

    // å¤„ç†ä¸‹æ‹‰æ¡†å˜åŒ–æ—¶çš„é€‰æ‹©æ–¹æ³•
    function updateModelSet(selectedModel) {
        model_set = selectedModel;
        console.log("Selected model:", model_set);
    }

    // é¡µé¢åŠ è½½æ—¶è°ƒç”¨è¯¥å‡½æ•°
    document.addEventListener("DOMContentLoaded", fetchModelData);


    async function sendMessage() {
        const prompt = document.getElementById("prompt").value.trim();
        const messagesDiv = document.getElementById("messages");

        if (!prompt && !uploadedImagePath) {
            alert("Please enter a message or upload an image.");
            return;
        }

        if (prompt) {
            // ç”¨æˆ·æ¶ˆæ¯æ”¯æŒ Markdown
            displayMessage("user", prompt);
        }

        const userMessageObject = {
            role: "user",
            content: prompt || "è¿™ä¸ªå›¾ç‰‡è¯´äº†ä»€ä¹ˆ",
        };

        if (uploadedImagePath) {
            userMessageObject.images = [uploadedImagePath];
        }

        conversationHistory.push(userMessageObject);

        document.getElementById("prompt").value = "";
        uploadedImagePath = null;

        try {
            const response = await fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    model: model_set,
                    messages: [...conversationHistory],
                }),
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let assistantMessage = document.createElement("div");
            assistantMessage.className = "message assistant";
            messagesDiv.appendChild(assistantMessage);

            let buffer = "";
            let assistantContent = ""; // å­˜å‚¨å®Œæ•´çš„ Markdown æ¶ˆæ¯å†…å®¹

            while (true) {
                const {value, done} = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, {stream: true});
                const lines = buffer.split("\n");
                buffer = lines.pop(); // ä¿ç•™æœªå®Œæˆçš„éƒ¨åˆ†

                for (const line of lines) {
                    try {
                        const parsedChunk = JSON.parse(line.trim());
                        if (parsedChunk.message && parsedChunk.message.content) {
                            const chunkContent = parsedChunk.message.content;
                            assistantContent += chunkContent;

                            // æ¸²æŸ“å½“å‰å†…å®¹ä¸º Markdown
                            assistantMessage.innerHTML = window.marked(assistantContent, {
                                sanitize: true, // å®‰å…¨æ¸²æŸ“
                                gfm: true,      // GitHub é£æ ¼ Markdown
                            });
                        }
                    } catch (e) {
                        console.error("Failed to parse chunk:", line);
                    }
                }

                scrollToBottom();
            }

            // å°†å®Œæ•´æ¶ˆæ¯å­˜å‚¨åˆ°ä¼šè¯å†å²ä¸­
            conversationHistory.push({role: "assistant", content: assistantContent});
        } catch (error) {
            console.error("Error:", error.message);
            alert(`Error: ${error.message}`);
        }
    }


    function scrollToBottom() {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function handleKeyDown(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    }
</script>
</body>
</html>
